# 환경 설정 가이드

## 개발 환경 요구사항

### 필수 설치 항목

1. **Java 21 LTS**
   - OpenJDK 21 또는 Oracle JDK 21
   - 설치 확인: `java -version`

2. **Docker & Docker Compose**
   - Docker Desktop (Windows/Mac) 또는 Docker Engine (Linux)
   - Docker Compose v2.0 이상
   - 설치 확인: `docker --version`, `docker-compose --version`

3. **Gradle 8.5 이상**
   - 프로젝트에 Gradle Wrapper 포함되어 있음
   - 별도 설치 불필요

### 권장 개발 도구

- IntelliJ IDEA Ultimate (추천)
- VS Code + Java Extension Pack
- Postman 또는 Insomnia (API 테스트)
- DBeaver 또는 DataGrip (DB 관리)
- Redis Desktop Manager (Redis 관리)

## 프로젝트 초기 설정

### 1. 저장소 클론

```bash
git clone <repository-url>
cd board
```

### 2. 환경 변수 설정

```bash
cp .env.example .env
# .env 파일을 열어 필요한 값 수정
```

### 3. 인프라 시작

```bash
# 자동 설정 스크립트 사용
./scripts/setup.sh

# 또는 수동으로 실행
docker-compose up -d
```

### 4. 빌드 및 실행

```bash
# Gradle 빌드
./gradlew clean build

# 애플리케이션 실행
./gradlew bootRun

# 또는 JAR 파일로 실행
java -jar build/libs/board-0.0.1-SNAPSHOT.jar
```

## 환경별 설정

### Local 환경 (개발)

- Profile: `local`
- 설정 파일: `application-local.yml`
- 특징:
  - H2 Console 활성화 (필요시)
  - SQL 로깅 활성화
  - DDL Auto: create-drop
  - 상세한 에러 메시지

**실행 방법:**
```bash
./gradlew bootRun --args='--spring.profiles.active=local'
```

### Production 환경

- Profile: `prod`
- 설정 파일: `application-prod.yml`
- 특징:
  - 환경 변수 기반 설정
  - SQL 로깅 비활성화
  - DDL Auto: validate
  - 최소한의 에러 정보

**실행 방법:**
```bash
export SPRING_PROFILES_ACTIVE=prod
export DB_URL=<production-db-url>
export DB_USERNAME=<db-username>
export DB_PASSWORD=<db-password>
export REDIS_HOST=<redis-host>
export JWT_SECRET=<jwt-secret>

java -jar build/libs/board-0.0.1-SNAPSHOT.jar
```

## JVM 옵션 설정

### 개발 환경

```bash
java -Xms512m -Xmx1g \
     -XX:+UseG1GC \
     -XX:MaxGCPauseMillis=200 \
     -jar build/libs/board-0.0.1-SNAPSHOT.jar
```

### 프로덕션 환경

```bash
java -Xms2g -Xmx4g \
     -XX:+UseG1GC \
     -XX:MaxGCPauseMillis=200 \
     -XX:+HeapDumpOnOutOfMemoryError \
     -XX:HeapDumpPath=/var/log/board/heapdump.hprof \
     -XX:+UseStringDeduplication \
     -XX:+OptimizeStringConcat \
     -Xlog:gc*:file=/var/log/board/gc.log:time,uptime:filecount=10,filesize=10M \
     -jar build/libs/board-0.0.1-SNAPSHOT.jar
```

### JVM 옵션 설명

- `-Xms`: 초기 힙 크기
- `-Xmx`: 최대 힙 크기
- `-XX:+UseG1GC`: G1 Garbage Collector 사용
- `-XX:MaxGCPauseMillis`: 최대 GC 일시 정지 목표 시간
- `-XX:+HeapDumpOnOutOfMemoryError`: OOM 발생 시 힙 덤프 생성
- `-XX:+UseStringDeduplication`: 중복 문자열 제거
- `-Xlog:gc*`: GC 로그 설정

## 데이터베이스 설정

### PostgreSQL

**로컬 개발:**
```yaml
spring:
  datasource:
    url: jdbc:postgresql://localhost:5432/board
    username: board
    password: board123
```

**연결 풀 설정:**
```yaml
spring:
  datasource:
    hikari:
      maximum-pool-size: 10      # 최대 연결 수
      minimum-idle: 5            # 최소 유휴 연결 수
      connection-timeout: 30000  # 연결 타임아웃 (ms)
      idle-timeout: 600000       # 유휴 연결 유지 시간 (ms)
      max-lifetime: 1800000      # 연결 최대 수명 (ms)
```

### Redis

**로컬 개발:**
```yaml
spring:
  data:
    redis:
      host: localhost
      port: 6379
      timeout: 3000
```

## 캐시 설정

### Ehcache (로컬 캐시)

설정 파일: `src/main/resources/ehcache.xml`

```xml
<cache alias="posts">
    <expiry>
        <ttl unit="minutes">30</ttl>
    </expiry>
    <resources>
        <heap unit="entries">500</heap>
        <offheap unit="MB">50</offheap>
    </resources>
</cache>
```

### Redis (분산 캐시)

```java
@Cacheable(value = "posts", key = "#id")
public Post findById(Long id) {
    // ...
}
```

## 모니터링 설정

### Actuator Endpoints

애플리케이션 시작 후 다음 엔드포인트 사용 가능:

- Health: http://localhost:8080/actuator/health
- Metrics: http://localhost:8080/actuator/metrics
- Prometheus: http://localhost:8080/actuator/prometheus

### Prometheus

- URL: http://localhost:9090
- 설정: `monitoring/prometheus.yml`

### Grafana

- URL: http://localhost:3000
- 기본 계정: admin/admin
- 데이터소스: Prometheus (http://prometheus:9090)

**대시보드 추가:**
1. Grafana 접속
2. Configuration > Data Sources > Add data source
3. Prometheus 선택 및 URL 입력
4. Dashboard > Import
5. Spring Boot 대시보드 ID 입력 (예: 4701, 6756)

## 보안 설정

### JWT 시크릿 키 생성

```bash
# 256비트 랜덤 키 생성
openssl rand -base64 32
```

생성된 키를 `JWT_SECRET` 환경 변수에 설정

### HTTPS 설정 (프로덕션)

```yaml
server:
  ssl:
    key-store: classpath:keystore.p12
    key-store-password: ${KEYSTORE_PASSWORD}
    key-store-type: PKCS12
    key-alias: board
  port: 8443
```

## 트러블슈팅

### 1. 포트 충돌

**증상:** Address already in use

**해결:**
```bash
# 포트 사용 중인 프로세스 확인 (Linux/Mac)
lsof -i :8080

# 포트 사용 중인 프로세스 확인 (Windows)
netstat -ano | findstr :8080

# Docker 컨테이너 확인
docker ps
```

### 2. 데이터베이스 연결 실패

**증상:** Connection refused

**해결:**
```bash
# PostgreSQL 상태 확인
docker-compose ps postgres

# 로그 확인
docker-compose logs postgres

# 재시작
docker-compose restart postgres
```

### 3. Gradle 빌드 실패

**증상:** Could not resolve dependencies

**해결:**
```bash
# Gradle 캐시 정리
./gradlew clean --refresh-dependencies

# Gradle Wrapper 재생성
gradle wrapper --gradle-version 8.5
```

### 4. OutOfMemoryError

**증상:** Java heap space

**해결:**
```bash
# 힙 크기 증가
java -Xms2g -Xmx4g -jar build/libs/board-0.0.1-SNAPSHOT.jar

# 힙 덤프 분석
jhat heapdump.hprof
```

## 유용한 명령어

### Gradle

```bash
# 빌드 (테스트 포함)
./gradlew build

# 빌드 (테스트 제외)
./gradlew build -x test

# 테스트만 실행
./gradlew test

# 특정 테스트 실행
./gradlew test --tests "com.board.domain.user.*"

# 의존성 확인
./gradlew dependencies

# 프로젝트 정보
./gradlew properties
```

### Docker

```bash
# 컨테이너 시작
docker-compose up -d

# 컨테이너 중지
docker-compose down

# 로그 확인
docker-compose logs -f

# 특정 서비스 재시작
docker-compose restart postgres

# 볼륨까지 삭제
docker-compose down -v
```

### 데이터베이스

```bash
# PostgreSQL 접속
docker-compose exec postgres psql -U board -d board

# 데이터베이스 백업
docker-compose exec postgres pg_dump -U board board > backup.sql

# 데이터베이스 복원
docker-compose exec -T postgres psql -U board board < backup.sql
```

### Redis

```bash
# Redis CLI 접속
docker-compose exec redis redis-cli

# 모든 키 확인
docker-compose exec redis redis-cli KEYS "*"

# 캐시 초기화
docker-compose exec redis redis-cli FLUSHALL
```

## 참고 자료

- [Spring Boot Reference Documentation](https://docs.spring.io/spring-boot/docs/current/reference/html/)
- [PostgreSQL Documentation](https://www.postgresql.org/docs/)
- [Redis Documentation](https://redis.io/documentation)
- [Gradle User Guide](https://docs.gradle.org/current/userguide/userguide.html)
- [Java 21 Documentation](https://docs.oracle.com/en/java/javase/21/)
