# 테스트 가이드

## 개요

이 프로젝트는 다음과 같은 테스트 전략을 사용합니다:

1. **Controller 테스트** - 성공 케이스 중심, REST Docs 문서 자동 생성
2. **Service 테스트** - 실패 케이스 중심, Mock을 활용한 단위 테스트

## 테스트 구조

```
src/test/
├── java/com/board/
│   ├── api/              # Controller 테스트 (통합 테스트)
│   │   └── AuthControllerTest.java
│   ├── service/          # Service 테스트 (단위 테스트)
│   │   └── AuthServiceTest.java
│   └── common/           # 테스트 공통 설정
│       ├── RestDocsConfiguration.java
│       └── RestDocsTestSupport.java
└── resources/
    └── application-test.yml
```

## 테스트 실행

### 1. 모든 테스트 실행

```bash
./gradlew test
```

### 2. 특정 테스트 클래스 실행

```bash
# Controller 테스트
./gradlew test --tests "com.board.api.AuthControllerTest"

# Service 테스트
./gradlew test --tests "com.board.service.AuthServiceTest"
```

### 3. 특정 테스트 메서드 실행

```bash
./gradlew test --tests "com.board.api.AuthControllerTest.signUp_Success"
```

### 4. 테스트 + API 문서 생성

```bash
./scripts/run-tests.sh
```

또는

```bash
./gradlew clean test asciidoctor
```

## Controller 테스트 (AuthControllerTest)

### 특징

- **@SpringBootTest** - 전체 애플리케이션 컨텍스트 로드
- **MockMvc** - HTTP 요청/응답 테스트
- **REST Docs** - API 문서 스니펫 자동 생성
- **실제 DB (H2)** - 통합 테스트 환경

### 테스트 케이스 (7개)

#### 성공 케이스 (3개)

1. **회원가입 성공**
   - 유효한 정보로 회원가입
   - 201 Created 응답
   - 사용자 정보 반환

2. **로그인 성공**
   - 등록된 사용자로 로그인
   - JWT 토큰 발급
   - 200 OK 응답

3. **토큰 재발급 성공**
   - Refresh Token으로 새 토큰 발급
   - 200 OK 응답

#### 실패 케이스 (4개)

4. **회원가입 실패 - Validation 오류**
   - 잘못된 이메일 형식
   - 짧은 비밀번호
   - 400 Bad Request

5. **로그인 실패 - 존재하지 않는 사용자**
   - 404 Not Found

6. **로그인 실패 - 잘못된 비밀번호**
   - 400 Bad Request

7. **추가 에러 케이스 문서화**

### 실행 예시

```bash
./gradlew test --tests "com.board.api.AuthControllerTest"
```

### 생성되는 REST Docs Snippets

```
build/generated-snippets/auth/
├── signup/
│   ├── http-request.adoc
│   ├── http-response.adoc
│   ├── request-fields.adoc
│   └── response-fields.adoc
├── login/
│   ├── http-request.adoc
│   ├── http-response.adoc
│   ├── request-fields.adoc
│   └── response-fields.adoc
└── refresh/
    ├── http-request.adoc
    ├── http-response.adoc
    ├── request-headers.adoc
    └── response-fields.adoc
```

## Service 테스트 (AuthServiceTest)

### 특징

- **@ExtendWith(MockitoExtension.class)** - Mockito 사용
- **@Mock** - 의존성 모킹
- **@InjectMocks** - 테스트 대상 주입
- **단위 테스트** - 빠른 실행, 외부 의존성 없음

### 테스트 케이스 (13개)

#### 실패 케이스 (10개)

1. **회원가입 실패 - 이메일 중복**
   - BusinessException(DUPLICATE_EMAIL)
   - 저장 메서드 호출 안됨 검증

2. **회원가입 실패 - 닉네임 중복**
   - BusinessException 발생
   - "이미 사용 중인 닉네임입니다."

3. **로그인 실패 - 존재하지 않는 사용자**
   - BusinessException(USER_NOT_FOUND)
   - 비밀번호 검증 안함

4. **로그인 실패 - 비밀번호 불일치**
   - BusinessException(INVALID_PASSWORD)
   - 토큰 생성 안됨

5. **로그인 실패 - 삭제된 사용자**
   - findActiveUserByEmail에서 조회 안됨
   - USER_NOT_FOUND

6. **토큰 재발급 실패 - 유효하지 않은 토큰**
   - BusinessException(UNAUTHORIZED)

7. **토큰 재발급 실패 - 사용자 없음**
   - 토큰은 유효하지만 사용자 삭제됨

8. **토큰 재발급 실패 - 삭제된 사용자의 토큰**
   - BusinessException(USER_NOT_FOUND)

9. **회원가입 실패 - Null 이메일**
   - IllegalArgumentException

10. **회원가입 실패 - 데이터베이스 오류**
    - RuntimeException("Database connection failed")

#### 성공 케이스 (3개)

11. **정상적인 회원가입**
    - UserResponse 반환
    - 모든 단계 검증

12. **정상적인 로그인**
    - TokenResponse 반환
    - 토큰 정보 검증

13. **정상적인 토큰 재발급**
    - 새로운 토큰 발급
    - 모든 메서드 호출 검증

### 실행 예시

```bash
./gradlew test --tests "com.board.service.AuthServiceTest"
```

### Mock 검증 예시

```java
// 메서드가 호출되지 않았는지 검증
verify(userRepository, never()).save(any(User.class));

// 특정 인자로 호출되었는지 검증
verify(userRepository).existsByEmail(request.getEmail());

// 호출 횟수 검증
verify(jwtTokenProvider, times(1)).createAccessToken(anyString(), anyString());
```

## API 문서 자동 생성

### 1. 문서 생성 프로세스

```
테스트 실행 → Snippets 생성 → AsciiDoc 빌드 → HTML 생성
```

### 2. 생성된 문서 확인

**로컬 파일:**
```bash
open build/docs/asciidoc/index.html
```

**애플리케이션에서 제공:**
```bash
# 애플리케이션 실행
./gradlew bootRun

# 브라우저에서 접속
http://localhost:8080/docs/index.html
```

### 3. 문서 내용

생성된 HTML 문서에는 다음 정보가 포함됩니다:

- **개요**
  - HTTP 동사 설명
  - HTTP 상태 코드
  - 에러 응답 형식
  - 에러 코드 목록

- **인증 API**
  - 회원가입
    - Request/Response 예시
    - 필드 설명
    - Validation 오류 예시
  - 로그인
    - Request/Response 예시
    - 에러 케이스
  - 토큰 재발급
    - Request/Response 예시
    - 헤더 설명

- **부록**
  - Validation 규칙 상세

## 테스트 커버리지

### 실행

```bash
./gradlew test jacocoTestReport
```

### 보고서 확인

```
build/reports/jacoco/test/html/index.html
```

## 테스트 작성 가이드

### Controller 테스트 작성 시

1. **RestDocsTestSupport 상속**
   ```java
   class MyControllerTest extends RestDocsTestSupport {
   ```

2. **성공 케이스 중심**으로 작성

3. **REST Docs 문서화** 추가
   ```java
   .andDo(document("api-name",
       requestFields(...),
       responseFields(...)
   ))
   ```

4. **주요 실패 케이스**도 문서화

### Service 테스트 작성 시

1. **Mockito 사용**
   ```java
   @ExtendWith(MockitoExtension.class)
   class MyServiceTest {
       @Mock
       private Repository repository;

       @InjectMocks
       private MyService service;
   }
   ```

2. **실패 케이스 중심**으로 작성

3. **given-when-then** 패턴 사용
   ```java
   // given
   given(repository.findById(1L)).willReturn(Optional.empty());

   // when & then
   assertThatThrownBy(() -> service.doSomething(1L))
       .isInstanceOf(BusinessException.class);
   ```

4. **Mock 호출 검증**
   ```java
   verify(repository).findById(1L);
   verify(repository, never()).save(any());
   ```

## CI/CD에서 테스트

### GitHub Actions 예시

```yaml
- name: Run tests
  run: ./gradlew test

- name: Generate API docs
  run: ./gradlew asciidoctor

- name: Upload test results
  uses: actions/upload-artifact@v3
  with:
    name: test-results
    path: build/test-results/

- name: Upload API docs
  uses: actions/upload-artifact@v3
  with:
    name: api-docs
    path: build/docs/asciidoc/
```

## 트러블슈팅

### 1. Redis 연결 오류

테스트용 application-test.yml에서 Redis를 embedded나 mock으로 설정

### 2. H2 호환성 문제

```yaml
spring:
  datasource:
    url: jdbc:h2:mem:testdb;MODE=PostgreSQL
```

### 3. REST Docs 스니펫 생성 안됨

- 테스트가 성공했는지 확인
- `@AutoConfigureRestDocs` 어노테이션 확인
- `RestDocsConfiguration` import 확인

### 4. 문서 생성 실패

```bash
# 캐시 삭제 후 재실행
./gradlew clean
./gradlew test asciidoctor
```

## 참고 자료

- [Spring REST Docs](https://docs.spring.io/spring-restdocs/docs/current/reference/html5/)
- [Mockito Documentation](https://javadoc.io/doc/org.mockito/mockito-core/latest/org/mockito/Mockito.html)
- [AssertJ Documentation](https://assertj.github.io/doc/)
- [JUnit 5 User Guide](https://junit.org/junit5/docs/current/user-guide/)
